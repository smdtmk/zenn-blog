---
title: "Athenaã‚’åˆ©ç”¨ã—ãŸVPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ç¢ºèªæ‰‹é †"
emoji: "ðŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "vpc", "athena", "s3"]
published: true
---

# VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’Amazon Athenaã§èª¿æŸ»ã™ã‚‹æ–¹æ³•

VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’Amazon Athenaã§åˆ†æžã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚VPCå†…ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å¯è¦–åŒ–ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒˆãƒ©ãƒ–ãƒ«ã®èª¿æŸ»ã«å½¹ç«‹ã¦ã¾ã—ã‚‡ã†ã€‚

## VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã¨ã¯

VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã¯ã€ä»®æƒ³ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰å†…ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹é–“ã§é€å—ä¿¡ã•ã‚Œã‚‹IPãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«é–¢ã™ã‚‹æƒ…å ±ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

### ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’è¨­å®šã§ãã‚‹ãƒªã‚½ãƒ¼ã‚¹

- VPC
- ã‚µãƒ–ãƒãƒƒãƒˆ
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ï¼ˆENIï¼‰

ã©ã®ãƒªã‚½ãƒ¼ã‚¹ã«è¨­å®šã—ã¦ã‚‚ã€å®Ÿéš›ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ã®ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ï¼ˆENIï¼‰ã§ã™ã€‚VPCã‚„ã‚µãƒ–ãƒãƒƒãƒˆã«è¨­å®šã—ãŸå ´åˆã¯ã€ãã®é…ä¸‹ã®ã™ã¹ã¦ã®ENIãŒå¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚

### å‡ºåŠ›å…ˆ

- **CloudWatch Logs**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚„ã‚¢ãƒ©ãƒ¼ãƒ ç™ºå ±ã«é©ã—ã¦ã„ã‚‹
- **S3ãƒã‚±ãƒƒãƒˆ**: é•·æœŸä¿å­˜ã‚„Athenaã§ã®åˆ†æžã«é©ã—ã¦ã„ã‚‹

æœ¬è¨˜äº‹ã§ã¯ã€S3ãƒã‚±ãƒƒãƒˆã«å‡ºåŠ›ã—ã¦Athenaã§åˆ†æžã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

- VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ãŒS3ãƒã‚±ãƒƒãƒˆã«å‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
- Athenaã§ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚‹ã“ã¨

## è¨­å®šæ‰‹é †

### 1. VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’S3ã¸å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«è¨­å®š

VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã®å‡ºåŠ›å…ˆã¨ãªã‚‹S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã€VPCã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å¯¾è±¡ã®VPCã‚’é¸æŠžã—ã¦ã€Œãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ä»¥ä¸‹ã®è¨­å®šã‚’è¡Œã„ã¾ã™ï¼š

![VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ä½œæˆç”»é¢](/images/vpcflowlog-check-manual/vpc-flow-log-creation.png)
*VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ä½œæˆç”»é¢ã®è¨­å®šé …ç›®*

- **åå‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**: è­˜åˆ¥ç”¨ã®åå‰ã‚’æŒ‡å®šï¼ˆä¾‹: `my-flow-log-01`ï¼‰
- **ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**: ã€Œã™ã¹ã¦ã€ï¼ˆæ‰¿è«¾ãƒ»å´ä¸‹ã®ä¸¡æ–¹ã‚’è¨˜éŒ²ï¼‰
- **æœ€å¤§é›†è¨ˆé–“éš”**: 10åˆ†ã¾ãŸã¯1åˆ†ã‚’é¸æŠžï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯10åˆ†ï¼‰
- **é€ä¿¡å…ˆ**: ã€ŒAmazon S3 ãƒã‚±ãƒƒãƒˆã«é€ä¿¡ã€ã‚’é¸æŠž
- **S3ãƒã‚±ãƒƒãƒˆARN**: é€ä¿¡å…ˆã®ARNã‚’æŒ‡å®šï¼ˆä¾‹: `arn:aws:s3:::bucket-name`ï¼‰
- **ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚¯ã‚»ã‚¹**: æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã€ã¾ãŸã¯æ–°è¦ä½œæˆã—ã¦ä½¿ç”¨ã‚’é¸æŠž
- **ãƒ­ã‚°ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å½¢å¼**: AWS ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¢å¼ã‚’é¸æŠž
- **è¿½åŠ ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: å¿…è¦ã«å¿œã˜ã¦Amazon ECS ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹ã«ãƒã‚§ãƒƒã‚¯

:::message
**ã‚«ã‚¹ã‚¿ãƒ å½¢å¼ã‚’é¸æŠžã™ã‚‹å ´åˆã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**:

- ç‰¹å®šã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ãŒå¿…è¦ã§ã€ãƒ­ã‚°ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã—ãŸã„å ´åˆ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹åˆ†æžã®ãŸã‚ã«ç‰¹å®šã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å«ã‚ãŸã„å ´åˆï¼ˆä¾‹: `pkt-src-aws-service`ï¼‰
- ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ã€ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é™¤å¤–ã—ãŸã„å ´åˆ
- ã‚«ã‚¹ã‚¿ãƒ åˆ†æžãƒ„ãƒ¼ãƒ«ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã€ç‰¹å®šã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é †åºãŒå¿…è¦ãªå ´åˆ

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¢å¼ã«ã¯ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã¾ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹IDã€é€ä¿¡å…ƒ/é€ä¿¡å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€ãƒ‘ã‚±ãƒƒãƒˆæ•°ã€ãƒã‚¤ãƒˆæ•°ã€é–‹å§‹/çµ‚äº†æ™‚åˆ»ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ãƒ­ã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã™ã€‚

ã»ã¨ã‚“ã©ã®ç”¨é€”ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå½¢å¼ã§ååˆ†ã§ã™ã€‚
:::

ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ä½œæˆã™ã‚‹ã¨ã€æŒ‡å®šã—ãŸS3ãƒã‚±ãƒƒãƒˆã«å¯¾ã—ã¦è‡ªå‹•çš„ã«ãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚é€šå¸¸ã¯ã“ã®è‡ªå‹•è¨­å®šã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¾ãŸãŽãªã©ç‰¹æ®Šãªè¦ä»¶ãŒã‚ã‚‹å ´åˆã¯ãƒãƒªã‚·ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

### 2. S3ãƒã‚±ãƒƒãƒˆã«ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ä½œæˆã—ã¦5åˆ†ã‹ã‚‰15åˆ†ç¨‹åº¦çµŒã¤ã¨ã€S3ãƒã‚±ãƒƒãƒˆå†…ã«è¨˜éŒ²ãŒä¿å­˜ã•ã‚Œå§‹ã‚ã¾ã™ã€‚

![S3ãƒã‚±ãƒƒãƒˆå†…ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ](/images/vpcflowlog-check-manual/s3-log-structure.png)
*S3ãƒã‚±ãƒƒãƒˆå†…ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ *

ãƒ­ã‚°ã®ä¿å­˜å…ˆã¯ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ«ãƒ€éšŽå±¤ã¨ãªã‚Šã¾ã™ï¼š

```text:ãƒ­ã‚°ã®ä¿å­˜å…ˆãƒ‘ã‚¹
{ä¿å­˜å…ˆãƒã‚±ãƒƒãƒˆ}/AWSLogs/{ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}/vpcflowlogs/{ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å}/YYYY/MM/DD/
```

ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åã®å‘½åè¦å‰‡ï¼š

```text:ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åã®å½¢å¼
{ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}_vpcflowlogs_{ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å}_{ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ID}_{ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—}_{ãƒãƒƒã‚·ãƒ¥å€¤}.log.gz
```

:::message alert
**æ³¨æ„**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒç™ºç”Ÿã—ãªã„é™ã‚Šã€ãƒ­ã‚°ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
:::

### 3. Athenaã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ

Athenaã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€Œã‚¯ã‚¨ãƒªã‚¨ãƒ‡ã‚£ã‚¿ã€ã‚’é–‹ãã€ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ï¼š

```sql:athena-create-database.sql
CREATE DATABASE VPCFlowLogs;
```

![Athenaã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ](/images/vpcflowlog-check-manual/athena-create-database.png)
*Athenaã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ãŸå¾Œã®ç”»é¢*

ã‚¯ã‚¨ãƒªãŒæˆåŠŸã—ãŸã‚‰ã€å·¦ä¸Šã®ã€ŒDatabaseã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠžã—ã¾ã™ã€‚

### 4. Athenaã§å¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ

S3ãƒã‚±ãƒƒãƒˆã«ä¿å­˜ã•ã‚ŒãŸãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’Athenaã§åˆ†æžã§ãã‚‹ã‚ˆã†ã«ã€å¤–éƒ¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```sql:athena-create-table.sql
CREATE EXTERNAL TABLE IF NOT EXISTS vpc_flow_logs (
  version int,
  account string,
  interfaceid string,
  sourceaddress string,
  destinationaddress string,
  sourceport int,
  destinationport int,
  protocol int,
  numpackets int,
  numbytes bigint,
  starttime int,
  endtime int,
  action string,
  logstatus string
)
PARTITIONED BY (dt string)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ' '
LOCATION 's3://your-bucket-name/AWSLogs/123456789012/vpcflowlogs/ap-northeast-1/'
TBLPROPERTIES ("skip.header.line.count"="1");
```

![Athenaã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ](/images/vpcflowlog-check-manual/athena-create-table.png)
*Athenaã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ãŸå¾Œã®ç”»é¢*

:::message
**ãƒã‚¤ãƒ³ãƒˆ**:

- `LOCATION`å¥ã®S3ãƒ‘ã‚¹ã¯ã€æ—¥ä»˜éƒ¨åˆ†ï¼ˆ`YYYY/MM/DD/`ï¼‰ã‚’å«ã‚ã¾ã›ã‚“
- S3ãƒã‚±ãƒƒãƒˆåã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¯å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„
- ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—åã¯ã€VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨å¯¾å¿œã•ã›ã¾ã™ï¼ˆãƒã‚¤ãƒ•ãƒ³ã¯ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«ç½®ãæ›ãˆï¼‰

:::

### 5. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€

ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ãŸã ã‘ã§ã¯ã€ã¾ã ãƒ‡ãƒ¼ã‚¿ã¯å–ã‚Šè¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

ç‰¹å®šã®æ—¥ä»˜ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ä¾‹ï¼š

```sql:athena-add-partition.sql
ALTER TABLE vpc_flow_logs
ADD PARTITION (dt='2025-02-23')
location 's3://your-bucket-name/AWSLogs/123456789012/vpcflowlogs/ap-northeast-1/2025/02/23';
```

![ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¿½åŠ ã®ç¢ºèª](/images/vpcflowlog-check-manual/athena-add-partition.png)
*ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¿½åŠ å¾Œã®ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ç”»é¢*

è¤‡æ•°ã®æ—¥ä»˜åˆ†ã‚’ã¾ã¨ã‚ã¦è¿½åŠ ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

```bash:add-partitions.sh
#!/bin/sh
START_DATE=2025-02-01
END_DATE=2025-02-28
TABLE_NAME=vpc_flow_logs
LOG_PATH=s3://your-bucket-name/AWSLogs/123456789012/vpcflowlogs/ap-northeast-1

CUR_DATE=$START_DATE
echo "ALTER TABLE $TABLE_NAME ADD"
while :
do
  SUB_DIR=`date -d "$CUR_DATE" "+%Y/%m/%d"`
  echo -n "PARTITION (dt="\'"$CUR_DATE"\'") location "\'"$LOG_PATH/$SUB_DIR/"\'
  if [ $CUR_DATE = $END_DATE ]; then
    echo ";"
    break
  else
    echo
  fi
  CUR_DATE=`date -d "$CUR_DATE 1 day" "+%Y-%m-%d"`
done
```

:::message alert
**æ³¨æ„**: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®è¿½åŠ ã¯ã€ã¾ã å­˜åœ¨ã—ãªã„S3ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦ã‚‚å¯èƒ½ã§ã™ã€‚å°†æ¥åˆ†ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’äº‹å‰ã«è¿½åŠ ã—ã¦ãŠãã“ã¨ã§ã€å¾Œã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚ŒãŸéš›ã«è‡ªå‹•çš„ã«ã‚¯ã‚¨ãƒªå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
:::

## ã‚¯ã‚¨ãƒªä¾‹

### ä¾‹1: æœŸé–“ã‚’æŒ‡å®šã—ã¦ãƒ­ã‚°ã‚’æŠ½å‡º

ç‰¹å®šã®æ™‚é–“å¸¯ã®ãƒ­ã‚°ã‚’æŠ½å‡ºã—ã¾ã™ï¼š

```sql:query-time-range.sql
SELECT
  from_unixtime(starttime, 9, 0) AS starttime_jst,
  from_unixtime(endtime, 9, 0) AS endtime_jst,
  interfaceid,
  sourceaddress,
  destinationaddress,
  sourceport,
  destinationport,
  protocol,
  numpackets,
  numbytes,
  action,
  logstatus
FROM vpc_flow_logs
WHERE from_unixtime(starttime, 9, 0) >= cast('2025-02-23 12:00:00 +09:00' as timestamp with time zone)
  AND from_unixtime(starttime, 9, 0) <  cast('2025-02-23 13:00:00 +09:00' as timestamp with time zone)
ORDER BY starttime;
```

![ã‚¯ã‚¨ãƒªçµæžœã®ä¾‹](/images/vpcflowlog-check-manual/query-result-time-range.png)

### ä¾‹2: æ‹’å¦ã•ã‚ŒãŸãƒ‘ã‚±ãƒƒãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹å…ƒIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸Šä½10å€‹

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èª¿æŸ»ã«æœ‰ç”¨ãªã‚¯ã‚¨ãƒªã§ã™ï¼š

```sql:query-reject-summary.sql
SELECT sourceaddress, COUNT(*) AS num_of_access
FROM vpc_flow_logs
WHERE action='REJECT'
GROUP BY sourceaddress
ORDER BY num_of_access DESC
LIMIT 10;
```

### ä¾‹3: ç‰¹å®šã®ãƒãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’èª¿æŸ»

```sql:query-ssh-access.sql
SELECT
  from_unixtime(starttime, 9, 0) AS starttime_jst,
  sourceaddress,
  destinationaddress,
  destinationport,
  action,
  numpackets,
  numbytes
FROM vpc_flow_logs
WHERE destinationport = 22  -- SSH
  AND dt >= '2025-02-23'
ORDER BY starttime DESC
LIMIT 100;
```

### ä¾‹4: ãƒ—ãƒ­ãƒˆã‚³ãƒ«åˆ¥ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯é‡ã‚’é›†è¨ˆ

```sql:query-protocol-summary.sql
SELECT
  CASE protocol
    WHEN 6 THEN 'TCP'
    WHEN 17 THEN 'UDP'
    WHEN 1 THEN 'ICMP'
    ELSE CAST(protocol AS VARCHAR)
  END AS protocol_name,
  SUM(numpackets) AS total_packets,
  SUM(numbytes) AS total_bytes,
  COUNT(*) AS flow_count
FROM vpc_flow_logs
WHERE dt >= '2025-02-23'
GROUP BY protocol
ORDER BY total_bytes DESC;
```

## æ³¨æ„äº‹é …

### åˆ—åã«ã¤ã„ã¦

:::message

- VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚¤ãƒ•ãƒ³ï¼ˆ`-`ï¼‰ã¯ã€Athenaã®åˆ—åã§ã¯ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼ˆ`_`ï¼‰ã«ç½®ãæ›ãˆã¾ã™
- Athenaã®äºˆç´„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€ãƒãƒƒã‚¯ãƒ†ã‚£ãƒƒã‚¯ï¼ˆ`` ` ``ï¼‰ã§å›²ã¿ã¾ã™

:::

### ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²ã®é‡è¦æ€§

ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼š

- **ã‚¯ã‚¨ãƒªé€Ÿåº¦ã®å‘ä¸Š**: å¿…è¦ãªæ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ãŸã‚ã€é«˜é€ŸåŒ–ã•ã‚Œã¾ã™
- **ã‚³ã‚¹ãƒˆå‰Šæ¸›**: ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ãƒ‡ãƒ¼ã‚¿é‡ãŒæ¸›ã‚‹ãŸã‚ã€Athenaã®èª²é‡‘ã‚‚å‰Šæ¸›ã•ã‚Œã¾ã™

WHEREå¥ã§`dt`åˆ—ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€åŠ¹çŽ‡çš„ã«ã‚¯ã‚¨ãƒªã§ãã¾ã™ï¼š

```sql:query-with-partition.sql
SELECT *
FROM vpc_flow_logs
WHERE dt >= '2025-02-23'
  AND dt <= '2025-02-25'
  AND action = 'REJECT';
```

## ã¾ã¨ã‚

VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’S3ãƒã‚±ãƒƒãƒˆã«å‡ºåŠ›ã—ã€Amazon Athenaã§åˆ†æžã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚

- VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’S3ã«å‡ºåŠ›ã™ã‚‹è¨­å®š
- Athenaã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€
- æ§˜ã€…ãªã‚¯ã‚¨ãƒªã§ãƒ­ã‚°ã‚’åˆ†æž

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒˆãƒ©ãƒ–ãƒ«ã®èª¿æŸ»æ™‚ã«ã€å¤§é‡ã®VPCãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’åŠ¹çŽ‡çš„ã«æŠ½å‡ºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚å®Ÿéš›ã«è¨­å®šã—ã¦ã€å¿…è¦ãªæ™‚ã«ã‚¹ãƒ ãƒ¼ã‚ºã«AthenaãŒä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

## å‚è€ƒè³‡æ–™

<https://docs.aws.amazon.com/ja_jp/athena/latest/ug/vpc-flow-logs.html>

<https://dev.classmethod.jp/articles/vpc-flow-logs-athena/>
